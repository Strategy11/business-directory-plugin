jQuery(function($){var wpbdp=window.wpbdp||{};wpbdp.submit_listing=wpbdp.submit_listing||{},wpbdp.submit_listing.Fee_Selection_Helper=function($submit,editing){this.editing=!("undefined"==typeof editing||!editing),this.reset()},$.extend(wpbdp.submit_listing.Fee_Selection_Helper.prototype,{reset:function(){this.field_wrapper=$(".wpbdp-form-field-association-category"),this.field_type="",this.plan_autoselect=!1,$(".wpbdp-js-select2",this.field_wrapper).length>0?this.field_type="select2":this.field_wrapper.hasClass("wpbdp-form-field-type-checkbox")?this.field_type="checkbox":this.field_wrapper.hasClass("wpbdp-form-field-type-radio")&&(this.field_type="radio"),this.field=this.field_wrapper.find('select, input[type="checkbox"], input[type="radio"]'),this.field_type&&("select2"==this.field_type&&this.field.find('option[disabled="disabled"]').data("keep_disabled",!0),this.editing||(this.skip_plan_selection=1==$('input[type="hidden"][name="skip_plan_selection"][value="1"]').length,this.skip_plan_selection||(this.$plans_container=$(".wpbdp-plan-selection-wrapper"),this.$plan_selection=this.$plans_container.find(".wpbdp-plan-selection"),this.plans=this.$plan_selection.find(".wpbdp-plan"),this.$plan_selection.hide(),this.selected_categories=[],this.available_plans=this.plans.map(function(){return $(this).data("id")}).get(),this.field.change($.proxy(this.categories_changed,this)),this.maybe_limit_category_options(),this.field.first().trigger("change"))))},categories_changed:function(){this.selected_categories=[],"select2"==this.field_type?this.selected_categories=this.field.val():"checkbox"==this.field_type?this.selected_categories=this.field.filter(":checked").map(function(){return $(this).val()}).get():"radio"==this.field_type&&(this.selected_categories=this.field.val()),this.selected_categories||(this.selected_categories=[]),$.isArray(this.selected_categories)||(this.selected_categories=[this.selected_categories]),this.selected_categories||(this.selected_categories=[]),this.selected_categories=$.map(this.selected_categories,function(x){return parseInt(x)}),this.update_plan_list(),this.update_plan_prices(),("checkbox"==this.field_type||this.field.is("[multiple]"))&&this.maybe_limit_category_options(),0==this.selected_categories.length?this.plans.find('input[name="listing_plan"]').prop({disabled:0==this.selected_categories.length,checked:!1}):this.plans.find('input[name="listing_plan"]').prop("disabled",!1);var self=this;if(this.selected_categories.length>0?(this.$plans_container.show(),Reusables.Breakpoints.evaluate(),this.$plan_selection.fadeIn("fast")):this.$plans_container.fadeOut("fast",function(){self.$plan_selection.hide()}),"select2"==this.field_type){var self=this;setTimeout(function(){self.field.select2({placeholder:wpbdpSubmitListingL10n.categoriesPlaceholderTxt})})}1===self.available_plans.length&&this.plan_autoselect&&$("#wpbdp-plan-select-radio-"+self.available_plans[0]).trigger("click"),this.plan_autoselect||(this.plan_autoselect=!0)},_enable_categories:function(categories){return"none"!=categories&&"all"!=categories&&this._enable_categories("none"),"none"==categories||"all"==categories?void("select2"==this.field_type?this.field.find("option").each(function(i,v){!0===$(this).data("keep_disabled")||$(this).prop("disabled","all"!=categories)}):(this.field.prop("disabled","all"!=categories),"all"==categories?this.field_wrapper.find(".wpbdp-form-field-checkbox-item, .wpbdp-form-field-radio-item").removeClass("disabled"):this.field_wrapper.find(".wpbdp-form-field-checkbox-item, .wpbdp-form-field-radio-item").addClass("disabled"))):void("select2"==this.field_type?this.field.find("option").each(function(i,v){!0===$(this).data("keep_disabled")||$(this).prop("disabled",-1==$.inArray(parseInt($(this).val()),categories))}):this.field.each(function(i,v){-1!=$.inArray(parseInt($(this).val()),categories)&&($(this).prop("disabled",!1),$(this).parents().filter(".wpbdp-form-field-checkbox-item, .wpbdp-form-field-radio-item").removeClass("disabled"))}))},maybe_limit_category_options:function(){var all_cats=!1,cats=[],self=this;$.each(this.available_plans,function(i,v){if(!all_cats){var plan_cats=self.plans.filter('[data-id="'+v+'"]').data("categories");"all"==plan_cats?all_cats=!0:(cats=$.unique(cats.concat(plan_cats.toString().split(","))),cats=$.map(cats,function(x){return parseInt(x)}))}}),all_cats?this._enable_categories("all"):this._enable_categories(cats)},update_plan_list:function(){var self=this,plans=[];$.each(this.plans,function(i,v){var $plan=$(v),plan_cats=$plan.data("categories").toString(),plan_supports_selection=!0;"all"!=plan_cats&&self.selected_categories&&(plan_cats=$.map(plan_cats.split(","),function(x){return parseInt(x)}),$.each(self.selected_categories,function(j,c){plan_supports_selection&&-1==$.inArray(c,plan_cats)&&(plan_supports_selection=!1)})),plan_supports_selection?(plans.push($plan.data("id")),$plan.show()):$plan.hide()}),self.available_plans=plans},update_plan_prices:function(){var self=this;$.each(self.available_plans,function(i,plan_id){var $plan=self.plans.filter('[data-id="'+plan_id+'"]'),pricing=$plan.data("pricing-details"),price=null;switch($plan.data("pricing-model")){case"variable":price=0,$.each(self.selected_categories,function(j,cat_id){price+=parseFloat(pricing[cat_id])});break;case"extra":price=parseFloat($plan.data("amount"))+parseFloat(pricing.extra)*self.selected_categories.length;break;case"flat":default:price=parseFloat($plan.data("amount"))}$plan.find(".wpbdp-plan-price-amount").text(price?$plan.data("amount-format").replace("[amount]",price.toFixed(2)):$plan.data("free-text")),1===self.available_plans.length&&$plan.find("#wpbdp-plan-select-radio-"+plan_id).prop("checked",!0)})}}),wpbdp.submit_listing.Handler=function($submit){this.$submit=$submit,this.$form=this.$submit.find("form"),this.editing="1"==this.$form.find('input[name="editing"]').val(),this.$sections=this.$submit.find(".wpbdp-submit-listing-section"),this.listing_id=this.$form.find('input[name="listing_id"]').val(),this.ajax_url=this.$form.attr("data-ajax-url"),this.doing_ajax=!1,this.setup_section_headers(),this.plan_handling();var self=this;this.$form.on("click",":reset",function(e){e.preventDefault(),self.$form.find('input[name="save_listing"]').val(""),self.$form.find('input[name="reset"]').val("reset"),self.$form.submit()}),$(window).on("wpbdp_submit_refresh",function(event,submit,section_id){self.fee_helper.reset()}),$("#wpbdp-submit-listing").on("change","#wpbdp-submit-listing-create_account",function(e){$("#wpbdp-submit-listing-account-details").toggle()}),$("#wpbdp-submit-listing").on("keyup",'#wpbdp-submit-listing-account-details input[type="password"]',function(e){self.check_password_strength($(this))}),$("#wpbdp-submit-listing").on("click",".wpbdp-inner-field-option-select_all",function(e){var $options=$(this).parent().find('input[type="checkbox"]');$options.prop("checked",$(this).find("input").is(":checked"))}),$(window).trigger("wpbdp_submit_init")},$.extend(wpbdp.submit_listing.Handler.prototype,{ajax:function(data,callback){if(this.doing_ajax)return void alert("Please wait a moment!");this.doing_ajax=!0;var self=this;$.post(this.ajax_url,data,function(res){return res.success?(self.doing_ajax=!1,void callback.call(self,res.data)):void alert("Something went wrong!")},"json")},setup_section_headers:function(){this.$sections.find(".wpbdp-submit-listing-section-header").click(function(){var $section=$(this).parent(".wpbdp-submit-listing-section");$section.toggleClass("collapsed")})},plan_handling:function(){if(this.fee_helper=new wpbdp.submit_listing.Fee_Selection_Helper(this.$submit,this.editing),this.skip_plan_selection=1==$('input[type="hidden"][name="skip_plan_selection"][value="1"]').length,this.editing){var $plan=this.$form.find(this.skip_plan_selection?".wpbdp-plan-selection .wpbdp-plan":".wpbdp-current-plan .wpbdp-plan"),plan_cats=$plan.length?$plan.data("categories").toString():"";if("all"!=plan_cats){var supported_categories=$.map($.unique(plan_cats.split(",")),function(x){return parseInt(x)});this.fee_helper._enable_categories(supported_categories)}}else{var self=this;this.$submit.on("change, click",'input[name="listing_plan"]',function(){if(1==$(this).parents(".wpbdp-plan").attr("data-disabled"))return!1;var data=self.$form.serialize();data+="&action=wpbdp_ajax&handler=submit_listing__sections",self.ajax(data,function(res){self.refresh(res)})}),this.$submit.on("click","#change-plan-link a",function(e){e.preventDefault();var data=self.$form.serialize();data+="&action=wpbdp_ajax&handler=submit_listing__reset_plan",self.ajax(data,function(res){self.refresh(res)})})}},refresh:function(data){var sections=data.sections,current_sections=(data.messages,this.$form.find(".wpbdp-submit-listing-section")),new_sections=sections,self=this;$.each(new_sections,function(section_id,section_details){var $section=current_sections.filter('[data-section-id="'+section_id+'"]'),$new_html=$(section_details.html);$section.find(".wpbdp-editor-area").each(function(){wp.editor.remove($(this).attr("id"))}),$section.attr("class",$new_html.attr("class")),$section.find(".wpbdp-submit-listing-section-content").fadeOut("fast",function(){var $new_content=$new_html.find(".wpbdp-submit-listing-section-content");$(this).replaceWith($new_content),Reusables.Breakpoints.scan($new_content),$section.find(".wpbdp-editor-area").each(function(){var id=$(this).attr("id");wp.editor.initialize(id,WPBDPTinyMCESettings[id])}),$(window).trigger("wpbdp_submit_refresh",[self,section_id,$section])})})},check_password_strength:function($input){var pass=$input.val(),$result=$input.siblings(".wpbdp-password-strength-meter");if($result.removeClass("strength-0 strength-2 strength-3 strength-4").html(""),pass){var strength=wp.passwordStrength.meter(pass,wp.passwordStrength.userInputBlacklist(),""),strength_msg="";switch(strength){case 2:strength_msg=pwsL10n.bad;break;case 3:strength_msg=pwsL10n.good;break;case 4:strength_msg=pwsL10n.strong;break;case 5:strength_msg=pwsL10n.mismatch;break;default:strength_msg=pwsL10n["short"]}$result.addClass("strength-"+(strength<5&&strength>=2?strength:"0")),$result.html(strength_msg)}}});var $submit=$("#wpbdp-submit-listing");if($(window).on("wpbdp_submit_init",function(){$submit.find(".wpbdp-editor-area").each(function(){var id=$(this).attr("id");wp.editor.initialize(id,WPBDPTinyMCESettings[id])})}),$submit.length>0){new wpbdp.submit_listing.Handler($submit)}});