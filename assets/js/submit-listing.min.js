jQuery(function($){var wpbdp=window.wpbdp||{};wpbdp.submit_listing=wpbdp.submit_listing||{},wpbdp.submit_listing.Fee_Selection_Helper=function($submit){this.reset()},$.extend(wpbdp.submit_listing.Fee_Selection_Helper.prototype,{reset:function(){this.field=$(".wpbdp-form-field-association-category select"),this.$plans_container=$(".wpbdp-plan-selection-with-tip"),this.is_multiple=this.field.prop("multiple"),this.plans=$(".wpbdp-plan-selection-list .wpbdp-plan"),this.selected_categories=[],this.available_plans=this.plans.map(function(){return $(this).data("id")}).get(),this.field.change($.proxy(this.categories_changed,this)),this.maybe_limit_category_options(),this.field.trigger("change")},categories_changed:function(){this.selected_categories=this.field.val(),this.selected_categories||(this.selected_categories=[]),$.isArray(this.selected_categories)||(this.selected_categories=[this.selected_categories]),this.selected_categories||(this.selected_categories=[]),this.update_plan_list(),this.update_plan_prices(),this.maybe_limit_category_options(),0==this.selected_categories.length?this.plans.find('input[name="listing_plan"]').prop({disabled:0==this.selected_categories.length,checked:!1}):this.plans.find('input[name="listing_plan"]').prop("disabled",!1),this.selected_categories.length>0?this.$plans_container.fadeIn("fast"):this.$plans_container.fadeOut("fast");var self=this;setTimeout(function(){self.field.select2({placeholder:wpbdpSubmitListingL10n.categoriesPlaceholderTxt})})},maybe_limit_category_options:function(){var all_cats=!1,cats=[],self=this;$.each(this.available_plans,function(i,v){if(!all_cats){var plan_cats=self.plans.filter('[data-id="'+v+'"]').data("categories");"all"==plan_cats?all_cats=!0:cats=$.unique(cats.concat(plan_cats.toString().split(",")))}}),all_cats?this.field.find("option").prop("disabled",!1):this.field.find("option").each(function(i,v){$(this).prop("disabled",-1==$.inArray($(this).val(),cats))})},update_plan_list:function(){var self=this,plans=[];$.each(this.plans,function(i,v){var $plan=$(v),plan_cats=$plan.data("categories").toString().split(","),plan_supports_selection=!0;"all"!=plan_cats&&self.selected_categories&&$.each(self.selected_categories,function(j,c){plan_supports_selection&&-1==$.inArray(c,plan_cats)&&(plan_supports_selection=!1)}),plan_supports_selection?(plans.push($plan.data("id")),$plan.show()):$plan.hide()}),self.available_plans=plans},update_plan_prices:function(){var self=this;$.each(self.available_plans,function(i,plan_id){var $plan=self.plans.filter('[data-id="'+plan_id+'"]'),pricing=$plan.data("pricing-details"),price=null;switch($plan.data("pricing-model")){case"variable":price=0,$.each(self.selected_categories,function(j,cat_id){price+=parseFloat(pricing[cat_id])});break;case"extra":price=$plan.data("amount")+pricing.extra*self.selected_categories.length;break;case"flat":default:price=$plan.data("amount")}$plan.find(".wpbdp-plan-price-amount").text(price?$plan.data("amount-format").replace("[amount]",price.toFixed(2)):$plan.data("free-text"))})}}),wpbdp.submit_listing.Handler=function($submit){this.$submit=$submit,this.$form=this.$submit.find("form"),this.$sections=this.$submit.find(".wpbdp-submit-listing-section"),this.listing_id=this.$form.find('input[name="listing_id"]').val(),this.ajax_url=this.$form.attr("data-ajax-url"),this.doing_ajax=!1,this.setup_section_headers(),this.plan_handling();var self=this;this.$form.on("click",":reset",function(e){e.preventDefault(),self.$form.find('input[name="save_listing"]').val(""),self.$form.find('input[name="reset"]').val("reset"),self.$form.submit()}),$("#wpbdp-submit-listing").on("change","#wpbdp-submit-listing-create_account",function(e){$("#wpbdp-submit-listing-account-details").toggle()})},$.extend(wpbdp.submit_listing.Handler.prototype,{ajax:function(data,callback){if(this.doing_ajax)return void alert("Please wait a moment!");this.doing_ajax=!0;var self=this;$.post(this.ajax_url,data,function(res){return res.success?(self.doing_ajax=!1,void callback.call(self,res.data)):void alert("Something went wrong!")},"json")},setup_section_headers:function(){this.$sections.find(".wpbdp-submit-listing-section-header").click(function(){var $section=$(this).parent(".wpbdp-submit-listing-section");$section.toggleClass("collapsed")})},plan_handling:function(){this.fee_helper=new wpbdp.submit_listing.Fee_Selection_Helper(this.$submit);var self=this;this.$submit.on("change, click",'input[name="listing_plan"]',function(){if(1==$(this).parents(".wpbdp-plan").attr("data-disabled"))return!1;var data=self.$form.serialize();data+="&action=wpbdp_ajax&handler=submit_listing__sections",self.ajax(data,function(res){self.refresh(res)})}),this.$submit.on("click","#change-plan-link a",function(e){e.preventDefault();var data=self.$form.serialize();data+="&action=wpbdp_ajax&handler=submit_listing__reset_plan",self.ajax(data,function(res){self.refresh(res)})})},refresh:function(data){var sections=data.sections,current_sections=(data.messages,this.$form.find(".wpbdp-submit-listing-section")),new_sections=sections,self=this;$.each(new_sections,function(section_id,section_details){var $section=current_sections.filter('[data-section-id="'+section_id+'"]'),$new_html=$(section_details.html);$section.attr("class",$new_html.attr("class")),$section.find(".wpbdp-submit-listing-section-content").fadeOut("fast",function(){$(this).replaceWith($new_html.find(".wpbdp-submit-listing-section-content")),self.fee_helper.reset()})})}});var $submit=$("#wpbdp-submit-listing");if($submit.length>0){new wpbdp.submit_listing.Handler($submit)}});