jQuery(function($){function handleError(msg,res){msg&&$(".wpbdp-page-csv-export div.error p").text(msg),res&&res.state&&(msg=res.state||lastState,$.ajax(ajaxurl,{data:{action:"wpbdp-csv-export",nonce:wpbdp_global.nonce,state:msg,cleanup:1},type:"POST"})),cancelExport=!0,exportInProgress=!1,$(".step-1, .step-2, .step-3").hide(),$(".wpbdp-page-csv-export div.error").show(),$(".canceled-export").show(),$("html, body").animate({scrollTop:0},"medium")}function advanceExport(state){exportInProgress&&(lastState=state,cancelExport?(exportInProgress=!1,cancelExport=!1,$(".step-2").fadeOut(function(){$(".canceled-export").fadeIn()}),$.ajax(ajaxurl,{data:{action:"wpbdp-csv-export",nonce:wpbdp_global.nonce,state:state,cleanup:1},type:"POST",dataType:"json",success(res){}})):$.ajax(ajaxurl,{data:{action:"wpbdp-csv-export",nonce:wpbdp_global.nonce,state:state},type:"POST",dataType:"json",success(res){!res||res.error?(exportInProgress=!1,handleError(res&&res.error?res.error:null,res)):($(".step-2 .listings").text(res.exported+" / "+res.count),$(".step-2 .size").text(res.filesize),progressBar.set(res.exported,res.count),res.isDone?(exportInProgress=!1,$(".step-2").fadeOut(function(){var downloadUrl=(res.download_url||res.fileurl).replace(/\s/g,"");existingToken=res.token,$(".step-3 .download-link a").attr("href",downloadUrl),$(".step-3 .download-link a .filename").text(res.filename),$(".step-3 .download-link a .filesize").text(res.filesize),$(".step-3").fadeIn(function(){$(".step-3 .cleanup-link").hide()})})):advanceExport(res.state))},error(){handleError()}}))}let progressBar=new WPBDP_Admin.ProgressBar($(".step-2 .export-progress")),exportInProgress=!1,cancelExport=!1,lastState=null,existingToken=null;$(document).on("submit","form#wpbdp-csv-export-form",function(e){e.preventDefault();e=$(this).serialize()+"&action=wpbdp-csv-export&nonce="+wpbdp_global.nonce;$.ajax(ajaxurl,{data:e,type:"POST",dataType:"json",success(res){!res||res.error?(exportInProgress=!1,handleError(res&&res.error?res.error:null,res)):$(".step-1").fadeOut(function(){exportInProgress=!0,$(".step-2 .listings").text("0 / "+res.count),$(".step-2 .size").text("0 KB"),$(".step-2").fadeIn(function(){advanceExport(res.state)})})},error(){handleError()}})}),$("a.cancel-import").on("click",function(e){e.preventDefault(),cancelExport=!0}),$(".step-3 .download-link a").on("click",function(e){$(".step-3 .cleanup-link").fadeIn()}),$(".step-3 .cleanup-link a").on("click",function(e){e.preventDefault(),$.ajax(ajaxurl,{data:{action:"wpbdp-csv-export",nonce:wpbdp_global.nonce,state:lastState,existing_token:existingToken,cleanup:1},type:"POST",dataType:"json",success(res){location.href=""}})})});