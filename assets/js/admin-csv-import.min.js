jQuery(function($){var $default_user_field,$form,$use_default_user_checkbox,csvimport={CSV_Import:function(){this.import_id=$("#wpbdp-csv-import-state").attr("data-import-id"),this.in_progress=!1,this.canceled=!1,this.processed_rows=0,this.total_rows=0,this.imported_rows=0,this.rejected_rows=0,this.warnings=[],this.$state=$("#wpbdp-csv-import-state"),this.$success=$("#wpbdp-csv-import-summary"),this.$progress_bar=new WPBDP_Admin.ProgressBar($(".import-progress")),this._setup_events()}};function update_textfield_value(event,ui){event.preventDefault(),void 0!==ui.item&&($default_user_field.val(ui.item.label),$default_user_field.siblings("#"+$default_user_field.attr("data-hidden-field")).val(ui.item.value))}$.extend(csvimport.CSV_Import.prototype,{_setup_events:function(){var t=this;$("a.cancel-import").on("click",function(e){e.preventDefault(),t.cancel()}),$("a.resume-import").on("click",function(e){e.preventDefault(),t.start_or_resume()})},_advance:function(){var t=this;t.in_progress&&(t.in_progress&&t.canceled&&(t.in_progress=!1),$.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"wpbdp-csv-import",import_id:t.import_id},success:function(res){if(!res||!res.success)return t._fatal_error(res.error);t.processed_rows=res.data.progress,t.total_rows=res.data.total,t.imported_rows=res.data.imported,t.rejected_rows=res.data.rejected,t.$progress_bar.set(t.processed_rows,t.total_rows),res.data.done?(t.in_progress=!1,t.warnings=res.data.warnings,t._show_success_screen()):t._advance()},error:function(){return t._fatal_error()}}))},_show_success_screen:function(){var t=this;t.$state.fadeOut(function(){var $warnings_table,$template_row;t.$state.remove(),t.$success.find(".placeholder-imported-rows").html(t.imported_rows),t.$success.find(".placeholder-rejected-rows").html(t.rejected_rows),(0==t.warnings.length?t.$success.find(".no-warnings"):($warnings_table=t.$success.find(".wpbdp-csv-import-warnings tbody"),$template_row=$warnings_table.find(".row-template"),$.each(t.warnings,function(i,v){var $r=$template_row.clone();$r.find(".col-line-no").html(v.line),$r.find(".col-line-content").html(v.content),$r.find(".col-warning").html(v.error),$warnings_table.append($r.show())}),t.$success.find(".with-warnings").show(),t.$success.find(".wpbdp-csv-import-warnings"))).show(),t.$success.fadeIn("fast")})},_fatal_error:function(msg){var $fatal_error=$("#wpbdp-csv-import-fatal-error"),$with_reason=$fatal_error.find(".with-reason"),$no_reason=$fatal_error.find(".no-reason");(msg?$with_reason.html($with_reason.html().replace("%s",msg)):$no_reason).show(),$fatal_error.show(),$("html, body").animate({scrollTop:0},"medium"),this.cancel()},start_or_resume:function(){this.in_progress||this.canceled||(this.in_progress=!0,$("a.resume-import").css("opacity","0.4"),$(".status-msg .not-started").hide(),$(".status-msg .in-progress").show(),this._advance())},cancel:function(){var t=this;t.canceled=!0,$(".canceled-import").show(),t.$state.remove(),$.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"wpbdp-csv-import",import_id:t.import_id,cleanup:1}})}}),$("a.wpbdp-example-csv").on("click",function(e){e.preventDefault(),$.ajax({url:ajaxurl,type:"POST",data:{action:"wpbdp-example-csv",nonce:wpbdp_global.nonce},success:function(res){var link=document.createElement("a"),res=new Blob(["\ufeff"+res],{type:"text/csv;charset=utf-8;"}),res=URL.createObjectURL(res);link.href=res,link.download="bd-example.csv",document.body.appendChild(link),link.click(),document.body.removeChild(link)}})}),0<$("#wpbdp-csv-import-state").length?new csvimport.CSV_Import:($(".wpbdp-page-csv-import .file-local-selection a.toggle-selection").on("click",function(e){e.preventDefault();e=$(this).siblings("ul");e.toggle(),e.is(":visible")||e.find('input[type="radio"]').prop("checked",!1)}),$(".wpbdp-page-csv-import").on("change",'.file-local-selection input[type="radio"]',function(e){""==$(this).filter(":checked").val()&&($(this).prop("checked",!1),$(this).parents(".file-local-selection").hide())}),$form=$("form#wpbdp-csv-import-form"),$use_default_user_checkbox=$form.find("input.use-default-listing-user"),$form.on("change","input.assign-listings-to-user",function(e){$(this).is(":checked")?$form.find(".default-user-selection").show():$form.find(".default-user-selection").hide(),$use_default_user_checkbox.trigger("change")}),$("input.assign-listings-to-user").trigger("change"),$(document).on("change",$use_default_user_checkbox,function(){$(this).is(":checked")?$form.find("select.default-user, input.default-user").closest("tr").show():$form.find("select.default-user, input.default-user").closest("tr").hide()}),$use_default_user_checkbox.trigger("change"),$default_user_field=$form.find(".wpbdp-user-autocomplete").autocomplete({source:ajaxurl+"?action=wpbdp-autocomplete-user",delay:500,minLength:2,select:update_textfield_value,focus:update_textfield_value}))});