name: Claude Auto-Fix Issues

on:
  repository_dispatch:
    types: [claude-fix]

jobs:
  assess:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      is_simple: ${{ steps.extract.outputs.is_simple }}
      reasoning: ${{ steps.extract.outputs.reasoning }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Assess issue complexity
        id: triage
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are an issue triage assistant for a WordPress plugin called Business Directory Plugin.

            ISSUE NUMBER: ${{ github.event.client_payload.issue_number }}
            ISSUE TITLE: ${{ github.event.client_payload.issue_title }}
            ISSUE BODY: ${{ github.event.client_payload.issue_body }}
            ISSUE AUTHOR: ${{ github.event.client_payload.issue_author }}

            Your task is to determine whether this issue describes a TRIVIAL bug that can be
            safely fixed by an automated system. Base your decision on the issue description
            alone -- do NOT browse the codebase. You must be VERY conservative.

            SIMPLE (mark is_simple: true) -- ONLY if ALL of these are true:
            - The issue clearly describes a small, mechanical fix
            - It would likely touch 1-2 files maximum
            - No change to control flow, query logic, or template rendering
            - No change to how data is fetched, filtered, or displayed
            - Examples: PHP notice for undefined variable, CSS color/font/spacing value change,
              typo in a string, missing esc_html() wrapper, missing isset() check, broken
              hardcoded URL, missing translation wrapper around a string literal

            NOT SIMPLE (mark is_simple: false) -- if ANY of these are true:
            - The fix requires understanding program flow or business logic
            - It involves changing what gets displayed or when
            - It involves template rendering, query modifications, or conditional behavior
            - It changes how a feature works (even slightly)
            - It requires adding new strings, messages, or UI elements that don't exist yet
            - It would likely touch 3+ files
            - It involves database queries or data model changes
            - It involves payment, billing, or subscription logic
            - It involves third-party API or gateway integrations
            - It requires changes to hooks, filters, or action priorities that affect behavior
            - The issue description is vague, lacks specifics, or requires interpretation
            - The issue is a feature request disguised as a bug
            - You are not 100% certain what the fix should be

            IMPORTANT: Your default answer should be is_simple: false. Only mark is_simple: true
            when the fix is genuinely trivial. When in doubt, ALWAYS say NOT simple.

            Return your assessment as structured JSON.
          claude_args: |
            --model claude-haiku-4-5-20250805
            --max-turns 15
            --allowedTools "Read,Bash(find:*),Bash(grep:*),Bash(cat:*)"
            --json-schema '{"type":"object","properties":{"is_simple":{"type":"boolean","description":"Whether the issue is low complexity and safe for automation"},"category":{"type":"string","description":"Short label like php-notice, css-fix, missing-check, typo, etc."},"estimated_files":{"type":"integer","description":"Estimated number of files that need to change"},"reasoning":{"type":"string","description":"1-2 sentence explanation of the assessment"}},"required":["is_simple","category","estimated_files","reasoning"]}'

      - name: Extract triage results
        id: extract
        if: steps.triage.outputs.structured_output != ''
        env:
          STRUCTURED_OUTPUT: ${{ steps.triage.outputs.structured_output }}
        run: |
          IS_SIMPLE=$(echo "$STRUCTURED_OUTPUT" | jq -r '.is_simple')
          REASONING=$(echo "$STRUCTURED_OUTPUT" | jq -r '.reasoning')
          echo "is_simple=$IS_SIMPLE" >> "$GITHUB_OUTPUT"
          echo "reasoning=$REASONING" >> "$GITHUB_OUTPUT"

      - name: Comment and remove label if too complex
        if: steps.extract.outputs.is_simple != 'true'
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
          REASONING: ${{ steps.extract.outputs.reasoning }}
          REQUESTED_BY: ${{ github.event.client_payload.sender }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          ISSUES_REPO: ${{ github.event.client_payload.issues_repo }}
        run: |
          REASON="${REASONING:-Assessment could not determine complexity.}"

          gh issue comment "$ISSUE_NUMBER" \
            --repo "$ISSUES_REPO" \
            --body "This issue has been assessed as too complex for automated fixing.

          **Reason:** $REASON

          @$REQUESTED_BY a human developer needs to handle this. Removing the \`claude-fix\` label."

          gh issue edit "$ISSUE_NUMBER" \
            --repo "$ISSUES_REPO" \
            --remove-label "claude-fix"

  fix:
    needs: assess
    if: needs.assess.outputs.is_simple == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
          tools: composer

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Fix the issue
        id: fix
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.client_payload.issue_number }}
            ISSUE TITLE: ${{ github.event.client_payload.issue_title }}
            ISSUE BODY: ${{ github.event.client_payload.issue_body }}
            ISSUE AUTHOR: ${{ github.event.client_payload.issue_author }}
            ISSUES REPO: ${{ github.event.client_payload.issues_repo }}

            You are fixing a low-complexity bug in the Business Directory Plugin for WordPress.
            The issue is tracked in a separate repository (${{ github.event.client_payload.issues_repo }})
            but the code lives here in ${{ github.repository }}.

            Steps:
            1. Read the issue carefully and understand what needs to change.
            2. Find the relevant code in the codebase.
            3. Implement the minimal, targeted fix. Do not refactor unrelated code.
            4. Follow WordPress coding standards. Use tabs for indentation.
            5. Every new or modified PHP function/method must have a doc comment with an @since x.x tag.
            6. If you modified PHP files, run: vendor/bin/phpcs --standard=phpcs.xml <changed_files>
               Fix any violations before committing.
            7. Create a PR in this repository (${{ github.repository }}). In the PR description:
               - Summarize the fix
               - Reference the issue: "${{ github.event.client_payload.issues_repo }}#${{ github.event.client_payload.issue_number }}"

            Rules:
            - Do NOT modify files in vendor/, vendors/, node_modules/, or languages/
            - Do NOT run build commands (npm run build, grunt, webpack)
            - Keep changes minimal and focused on the reported issue
            - Use `isset()` or null coalescing when accessing potentially undefined variables
            - Escape output with appropriate WordPress functions (esc_html, esc_attr, etc.)
            - Use the text domain "business-directory-plugin" for any translatable strings
          claude_args: |
            --allowedTools "Read,Write,Edit,Bash(git:*),Bash(gh pr create:*),Bash(gh pr comment:*),Bash(vendor/bin/phpcs:*),Bash(vendor/bin/phpcbf:*),Bash(find:*),Bash(grep:*),Bash(cat:*),Bash(ls:*)"

      - name: Notify label applier
        if: steps.fix.outputs.branch_name != ''
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
          BRANCH_NAME: ${{ steps.fix.outputs.branch_name }}
          REQUESTED_BY: ${{ github.event.client_payload.sender }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          ISSUES_REPO: ${{ github.event.client_payload.issues_repo }}
        run: |
          PR_URL=$(gh pr list --head "$BRANCH_NAME" --repo "${{ github.repository }}" --json url --jq '.[0].url')

          if [ -n "$PR_URL" ]; then
            gh issue comment "$ISSUE_NUMBER" \
              --repo "$ISSUES_REPO" \
              --body "An automated fix has been created for this issue: $PR_URL

          @$REQUESTED_BY please review and test the changes."
          fi
